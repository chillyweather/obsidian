# Validating Inbound Server Data

It's common practice to validate an incoming request. If the client doesn't send what we expect to receive from them, the controller simply doesn't start, and the client receives an error. To make this possible, the request is described with a schema.

## Joi and Celebrate

Joi is a popular Node.js library for data validation. It allows you to describe data in an intuitive way:

```jsx
{
  body: Joi.object().keys({
    email: Joi.string().required().email(),
    password: Joi.string().required().min(8),
    name: Joi.string().required().min(2).max(30),
    age: Joi.number().integer().required().min(18),
    about: Joi.string().min(2).max(30),
  })
}
```

The code says that `body` must be an object with keys:

-   `email` — a string, required field, must match the email pattern.
-   `password` — required string, at least 8 characters.
-   `name` — a required string from 2 to 30 characters.
-   `age` — number, integer, required, the minimum possible value is 18.
-   `about` — string from 2 to 30 characters.

We'll use the celebrate library to enable Joi validation as middleware. First, you need to install it in the project, then import it, and finally connect it as middleware to the route:

```jsx
const { celebrate, Joi } = require('celebrate');

router.post('/posts', celebrate({
  body: Joi.object().keys({
    title: Joi.string().required().min(2).max(30),
    text: Joi.string().required().min(2),
  }),
}), createPost);
```

This middleware validates the request body and ensures that it has the `title` and `text` fields. If the request body fails validation, the `createPost` controller won't run at all.

Besides the request body, _celebrate_ allows you to validate headers, parameters, or `req.query`:

```jsx
const { celebrate, Joi } = require('celebrate');

router.delete('/:postId', celebrate({
  // validate parameters
  params: Joi.object().keys({
    postId: Joi.string().alphanum().length(24),
  }),
  headers: Joi.object().keys({
    // validate headers
  }),
  query: Joi.object().keys({
    // validate query
  }),
}), deletePost);
```

By default, Joi doesn't allow fields that are not listed in the validation object. To change this behavior, after calling the `keys()` method, call the `unknown()` method with `true` as an argument:

```jsx
const { celebrate, Joi } = require('celebrate');

router.delete('/:postId', celebrate({
  headers: Joi.object().keys({
    // validate headers
  }).unknown(true),
}), deletePost);
```

## Errors

If the request doesn't pass the described validation, _celebrate_ will pass it on to the error handler but not to the controller. _celebrate_ has a special `errors()` middleware for sending errors to the client:

```jsx
// app.js

const { errors } = require('celebrate');

// ...

// error handlers
app.use(errors()); // celebrate error handler

// our centralized handler
app.use((err, req, res, next) => {
  // ...
});
```

The `errors()` middleware will only handle errors generated by _celebrate_. It will pass all other errors further, where the centralized error handler will catch them.

The error status returned by _celebrate_ is `400`, and the response body is:

```jsx
"child \"name\" fails because [\"name\" is required]",{
    "statusCode": 400,
    "error": "Bad Request",
    "message": "child \"name\" fails because [\"name\" is required]",
    "validation": {
        "source": "body",
        "keys": [
            "name"
        ]
    }
}
```

The `message` field allows the client to understand what is wrong with their request. In this case, _celebrate_ reports that the required `name` field is missing in the request body.